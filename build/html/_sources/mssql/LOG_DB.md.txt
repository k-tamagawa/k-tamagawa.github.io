# LOG_DB

## 操作ログ（利用者）

```sql
USE LOG_DB
GO

DECLARE @START_DATE VARCHAR(19) = '2021/09/03 15:30:00';
DECLARE @END_DATE DATETIME = GETDATE();
--DECLARE @END_DATE VARCHAR(19) = '2021/09/03 15:40:00';

SELECT DISTINCT
    USERNAME AS "OSユーザーID"
  , (SELECT USER_NM FROM  TPORT_DB.dbo.M_USER WHERE M_USER.USER_ID = SUBSTRING(LOG.USERNAME,CHARINDEX('\',USERNAME)+1,10) ) AS "ユーザー名"
  , substring(MESSAGE,2,2) AS "センターCD"
  , (SELECT case CENTER_NM_ABB when '' then CENTER_NM else CENTER_NM_ABB end FROM M_CENTER WHERE M_CENTER.CENTER_CD = substring(MESSAGE,2,2)) AS "センター名"
FROM [dbo].[LOG_TBL] LOG
WHERE ENT_DATE BETWEEN @START_DATE AND @END_DATE
AND MESSAGE LIKE '[[][0-9a-zA-Z][0-9a-zA-Z]][[][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ]]%' 
AND LEVEL = 'TRACE'
GO
```

## 操作ログ検索（TRACE）

```sql
USE LOG_DB
GO

DECLARE @START_DATE VARCHAR(19) = '2021/09/03 15:30:00';
DECLARE @END_DATE DATETIME = GETDATE();
--DECLARE @END_DATE VARCHAR(19) = '2021/09/03 15:40:00';

SELECT ID AS ID
  , ENT_DATE AS "登録日"
  , USERNAME AS "OSユーザーID"
  , (SELECT USER_NM FROM  TPORT_DB.dbo.M_USER WHERE M_USER.USER_ID = SUBSTRING(LOG.USERNAME,CHARINDEX('\',USERNAME)+1,10) ) AS "ユーザー名"
  , substring(MESSAGE,21,9) AS "画面ID"
  , (SELECT NAME FROM LOG_FORM_NAME WHERE LOG_FORM_NAME.FORM_ID = substring(MESSAGE,21,9) ) AS "画面名"
  , substring(MESSAGE,2,2) AS "センターCD"
  , (SELECT case CENTER_NM_ABB when '' then CENTER_NM else CENTER_NM_ABB end FROM M_CENTER WHERE M_CENTER.CENTER_CD = substring(MESSAGE,2,2)) AS "センター名"
  , METHOD AS "関数名"
  , [LEVEL] AS "ログレベル"
  , MESSAGE
FROM [dbo].[LOG_TBL] LOG
WHERE ENT_DATE BETWEEN @START_DATE AND @END_DATE
--AND USERNAME IN(SELECT 'TRANCOM-DOMAIN\' + RTRIM(USER_ID) FROM TPORT_DB.dbo.M_USER WHERE DEL_FLG = '0')
AND MESSAGE LIKE '[[][0-9a-zA-Z][0-9a-zA-Z]][[][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ][0-9a-zA-Z ]]%' 
AND LEVEL = 'TRACE'
--AND LEVEL IN ('TRACE','INFO','WARN', 'ERROR')
GO
```

## 操作ログ検索（ERROR）

```sql
USE LOG_DB
GO

DECLARE @START_DATE VARCHAR(19) = '2022/02/04 18:35:00';
--DECLARE @END_DATE DATETIME = GETDATE();
DECLARE @END_DATE VARCHAR(19) = '2022/02/04 18:42:00';

SELECT ID AS ID
  , ENT_DATE AS "登録日"
  , USERNAME AS "OSユーザーID"
  , (SELECT USER_NM FROM  TPORT_DB.dbo.M_USER WHERE M_USER.USER_ID = SUBSTRING(LOG.USERNAME,CHARINDEX('\',USERNAME)+1,10) ) AS "ユーザー名"
  , substring(MESSAGE,21,9) AS "画面ID"
  , (SELECT NAME FROM LOG_FORM_NAME WHERE LOG_FORM_NAME.FORM_ID = substring(MESSAGE,21,9) ) AS "画面名"
  , substring(MESSAGE,2,2) AS "センターCD"
  , (SELECT case CENTER_NM_ABB when '' then CENTER_NM else CENTER_NM_ABB end FROM M_CENTER WHERE M_CENTER.CENTER_CD = substring(MESSAGE,2,2)) AS "センター名"
  , METHOD AS "関数名"
  , [LEVEL] AS "ログレベル"
  , MESSAGE
FROM [dbo].[LOG_TBL] LOG
WHERE ENT_DATE BETWEEN @START_DATE AND @END_DATE
AND MESSAGE LIKE '[^[]%' --TRACE時のフォーマットでは入ってこないものを検索
AND LEVEL IN ('TRACE','INFO','WARN', 'ERROR')
GO

-- ユーザー名とセンター名を無理やり結合
USE LOG_DB
GO

DECLARE @START_DATE VARCHAR(19) = '2022/04/14 08:30:00';
--DECLARE @END_DATE DATETIME = GETDATE();
DECLARE @END_DATE VARCHAR(19) = '2022/04/14 14:00:00';

SELECT ID AS ID
  , ENT_DATE AS "登録日"
  , replace(USERNAME,'TRANCOM-DOMAIN\','') AS "ユーザーID"
  , (SELECT USER_NM FROM  TPORT_DB.dbo.M_USER WHERE M_USER.USER_ID = SUBSTRING(LOG.USERNAME,CHARINDEX('\',USERNAME)+1,10) ) AS "ユーザー名"
  , (SELECT case CENTER_NM_ABB when '' then CENTER_NM else CENTER_NM_ABB end FROM M_CENTER WHERE M_CENTER.CENTER_CD = (SELECT A.CENTER_CD FROM TPORT_DB.dbo.M_USER A WHERE A.USER_ID = replace(USERNAME,'TRANCOM-DOMAIN\','')) ) AS "センター名"
  , METHOD AS "関数名"
  , [LEVEL] AS "ログレベル"
  , MESSAGE
FROM [dbo].[LOG_TBL] LOG
WHERE ENT_DATE BETWEEN @START_DATE AND @END_DATE
AND MESSAGE LIKE '[^[]%' --TRACE時のフォーマットでは入ってこないものを検索
AND LEVEL IN ('TRACE','INFO','WARN', 'ERROR')
ORDER BY 2
GO

```
