

<!DOCTYPE html>
<html class="writer-html5" lang="ja" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>3.1. 共通 &mdash; Sphinx 1.0.5 ドキュメント</title>
  

  
  <link rel="stylesheet" href="../_static/css/my_theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/my_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>
        <script src="../_static/js/register.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="3.2. LOG_DB" href="LOG_DB.html" />
    <link rel="prev" title="3. 保守用：SQL Server" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Sphinx
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">目次:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../sphinx.html">1. Sphinxの環境構築～サイト更新</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sample/index.html">2. サンプル集</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">3. 保守用：SQL Server</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">3.1. 共通</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">3.1.1. レコード件数取得</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">3.1.2. テーブル定義</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">3.1.3. テーブル一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">3.1.4. インデックス一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">3.1.5. ユーザーマッピング</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">3.1.6. デバッグ権限付与</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">3.1.7. ストアド検索</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">3.1.8. インデックスの断片化</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">3.1.9. ヒット率</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">3.1.10. 統計情報の調査</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">3.1.11. 権限の確認</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="LOG_DB.html">3.2. LOG_DB</a></li>
<li class="toctree-l2"><a class="reference internal" href="command.html">3.3. コマンド一覧</a></li>
<li class="toctree-l2"><a class="reference internal" href="other_sql.html">3.4. その他SQL</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../mysql/index.html">4. 保守用：MySQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../redmine/index.html">5. 構成管理SV：Redmine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../git/index.html">6. Git</a></li>
<li class="toctree-l1"><a class="reference internal" href="../svn/index.html">7. SVN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker/index.html">8. Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wsl2/index.html">9. Windows Subsystem for Linux 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../msys2/index.html">10. MSYS2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other_command/index.html">11. その他コマンド</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other_config/index.html">12. その他設定</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bookmark/index.html">13. ブックマーク</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shortcut/index.html">14. ショートカット</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kintai/index.html">15. 勤怠</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Sphinx</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html"><span class="section-number">3. </span>保守用：SQL Server</a> &raquo;</li>
        
      <li><span class="section-number">3.1. </span>共通</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/mssql/common.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="tex2jax_ignore mathjax_ignore section" id="id1">
<h1><span class="section-number">3.1. </span>共通<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="id2">
<h2><span class="section-number">3.1.1. </span>レコード件数取得<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- レコード多くてcountでは取得できない時</span>
<span class="k">SELECT</span><span class="w"></span>
<span class="w">  </span><span class="k">SCHEMA_NAME</span><span class="p">(</span><span class="n">A</span><span class="p">.</span><span class="n">schema_id</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="k">AVG</span><span class="p">(</span><span class="n">B</span><span class="p">.</span><span class="k">rows</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s1">&#39;RowCount&#39;</span><span class="w"></span>
<span class="k">FROM</span><span class="w">        </span><span class="n">sys</span><span class="p">.</span><span class="n">objects</span><span class="w"> </span><span class="n">A</span><span class="w"></span>
<span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">partitions</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">object_id</span><span class="w"></span>
<span class="k">WHERE</span><span class="w">       </span><span class="n">A</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">    </span><span class="n">A</span><span class="p">.</span><span class="n">schema_id</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">Name</span><span class="w"></span>
<span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2><span class="section-number">3.1.2. </span>テーブル定義<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- 論理名やプライマリーキーを含めてテーブル定義を取得</span>
<span class="k">SELECT</span><span class="w"></span>
<span class="w">  </span><span class="c1">--t.object_id,</span>
<span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">column_id</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s1">&#39;テーブル名&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">--t.name as &#39;テーブル名&#39;,</span>
<span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">column_id</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">ep_t</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s1">&#39;テーブル論理名&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">--ep_t.value as &#39;テーブル論理名&#39;,</span>
<span class="w">  </span><span class="c1">--t.type as タイプ,</span>
<span class="w">  </span><span class="c1">--c.column_id,</span>
<span class="w">  </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s1">&#39;列名&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">ep_c</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s1">&#39;列論理名&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">pk_tbl</span><span class="p">.</span><span class="n">key_ordinal</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">pk_tbl</span><span class="p">.</span><span class="n">key_ordinal</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">)</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">PK</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s1">&#39;データ型&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%char%&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">max_length</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">)</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s1">&#39;サイズ&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">c</span><span class="p">.</span><span class="n">max_length</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s1">&#39;長さ&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%char%&#39;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="k">scale</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">)</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s1">&#39;小数点桁数&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">is_nullable</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s1">&#39;NULL許可&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">REPLACE</span><span class="p">(</span><span class="k">REPLACE</span><span class="p">(</span><span class="k">COALESCE</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">definition</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s1">&#39;デフォルト値&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">column_id</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">VARCHAR</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">create_date</span><span class="p">,</span><span class="mi">121</span><span class="p">)</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s1">&#39;テーブル作成日&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">column_id</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">VARCHAR</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">modify_date</span><span class="p">,</span><span class="mi">121</span><span class="p">)</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s1">&#39;テーブル更新日&#39;</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">objects</span><span class="w"> </span><span class="n">t</span><span class="w"></span>
<span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">columns</span><span class="w"> </span><span class="k">c</span><span class="w"></span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">object_id</span><span class="w"></span>
<span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">types</span><span class="w"> </span><span class="n">n</span><span class="w"></span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">system_type_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">system_type_id</span><span class="w"></span>
<span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">default_constraints</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">d</span><span class="w"></span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">parent_object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">object_id</span><span class="w"></span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">parent_column_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">column_id</span><span class="w"></span>
<span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">extended_properties</span><span class="w"> </span><span class="n">ep_t</span><span class="w"></span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ep_t</span><span class="p">.</span><span class="n">major_id</span><span class="w"></span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">ep_t</span><span class="p">.</span><span class="n">minor_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">extended_properties</span><span class="w"> </span><span class="n">ep_c</span><span class="w"></span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ep_c</span><span class="p">.</span><span class="n">major_id</span><span class="w"></span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">column_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ep_c</span><span class="p">.</span><span class="n">minor_id</span><span class="w"></span>
<span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="n">tbls</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">table_name</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="n">key_const</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">constraint_name</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="n">idx_cols</span><span class="p">.</span><span class="n">key_ordinal</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">key_ordinal</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="n">cols</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">col_name</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">tables</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tbls</span><span class="w"></span>
<span class="w">  </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">key_constraints</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">key_const</span><span class="w"></span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">tbls</span><span class="p">.</span><span class="n">object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key_const</span><span class="p">.</span><span class="n">parent_object_id</span><span class="w"></span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">key_const</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;pk&#39;</span><span class="w"></span>
<span class="w">  </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">index_columns</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">idx_cols</span><span class="w"></span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">key_const</span><span class="p">.</span><span class="n">parent_object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx_cols</span><span class="p">.</span><span class="n">object_id</span><span class="w"></span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">key_const</span><span class="p">.</span><span class="n">unique_index_id</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">idx_cols</span><span class="p">.</span><span class="n">index_id</span><span class="w"></span>
<span class="w">  </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">columns</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cols</span><span class="w"></span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">idx_cols</span><span class="p">.</span><span class="n">object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cols</span><span class="p">.</span><span class="n">object_id</span><span class="w"></span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">idx_cols</span><span class="p">.</span><span class="n">column_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cols</span><span class="p">.</span><span class="n">column_id</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span><span class="n">pk_tbl</span><span class="w"></span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">pk_tbl</span><span class="p">.</span><span class="k">table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="w"></span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">pk_tbl</span><span class="p">.</span><span class="n">col_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">column_id</span><span class="w"></span>
<span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2><span class="section-number">3.1.3. </span>テーブル一覧<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s1">&#39;TableName&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ep</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s1">&#39;PropertyValue&#39;</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">tables</span><span class="w"> </span><span class="n">t</span><span class="w"></span>
<span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">extended_properties</span><span class="w"> </span><span class="n">ep</span><span class="w"></span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">ep</span><span class="p">.</span><span class="n">major_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">object_id</span><span class="w"></span>
<span class="w">  </span><span class="k">AND</span><span class="w">  </span><span class="n">ep</span><span class="p">.</span><span class="n">minor_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">ep</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;MS_Description&#39;</span><span class="w"></span>
<span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h2><span class="section-number">3.1.4. </span>インデックス一覧<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">SchemaName</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">O</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ObjectName</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">I</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">IndexName</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">I</span><span class="p">.</span><span class="n">type_desc</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">IndexTypeDesc</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">I</span><span class="p">.</span><span class="n">is_primary_key</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">IsPrimaryKey</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">I</span><span class="p">.</span><span class="n">is_unique</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">IsUnique</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">I</span><span class="p">.</span><span class="n">is_disabled</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">IsDisabled</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">STUFF</span><span class="p">((</span><span class="k">SELECT</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">COL_NAME</span><span class="p">(</span><span class="n">IC</span><span class="p">.</span><span class="n">object_id</span><span class="p">,</span><span class="w"> </span><span class="n">IC</span><span class="p">.</span><span class="n">column_id</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">index_columns</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">IC</span><span class="w"></span>
<span class="w">         </span><span class="k">WHERE</span><span class="w"> </span><span class="n">IC</span><span class="p">.</span><span class="n">is_included_column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">         </span><span class="k">AND</span><span class="w"> </span><span class="n">IC</span><span class="p">.</span><span class="n">object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">object_id</span><span class="w"></span>
<span class="w">         </span><span class="k">AND</span><span class="w"> </span><span class="n">IC</span><span class="p">.</span><span class="n">index_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">index_id</span><span class="w"></span>
<span class="w">         </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">IC</span><span class="p">.</span><span class="n">key_ordinal</span><span class="w"></span>
<span class="w">         </span><span class="k">FOR</span><span class="w"> </span><span class="n">XML</span><span class="w"> </span><span class="n">PATH</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">KeyColumns</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">STUFF</span><span class="p">((</span><span class="k">SELECT</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">COL_NAME</span><span class="p">(</span><span class="n">IC</span><span class="p">.</span><span class="n">object_id</span><span class="p">,</span><span class="w"> </span><span class="n">IC</span><span class="p">.</span><span class="n">column_id</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">index_columns</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">IC</span><span class="w"></span>
<span class="w">         </span><span class="k">WHERE</span><span class="w"> </span><span class="n">IC</span><span class="p">.</span><span class="n">is_included_column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">         </span><span class="k">AND</span><span class="w"> </span><span class="n">IC</span><span class="p">.</span><span class="n">object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">object_id</span><span class="w"></span>
<span class="w">         </span><span class="k">AND</span><span class="w"> </span><span class="n">IC</span><span class="p">.</span><span class="n">index_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">index_id</span><span class="w"></span>
<span class="w">         </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">IC</span><span class="p">.</span><span class="n">index_column_id</span><span class="w"></span>
<span class="w">         </span><span class="k">FOR</span><span class="w"> </span><span class="n">XML</span><span class="w"> </span><span class="n">PATH</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">IncludedColumns</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">indexes</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">I</span><span class="w"></span>
<span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">objects</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">O</span><span class="w"></span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">O</span><span class="p">.</span><span class="n">object_id</span><span class="w"></span>
<span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">schemas</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">S</span><span class="w"></span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">O</span><span class="p">.</span><span class="n">schema_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">schema_id</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">index_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="k">AND</span><span class="w"> </span><span class="n">O</span><span class="p">.</span><span class="n">is_ms_shipped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">.</span><span class="n">name</span><span class="w"></span>
<span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h2><span class="section-number">3.1.5. </span>ユーザーマッピング<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="cm">/* 不明なユーザー一覧を表示する方法 */</span><span class="w"></span>
<span class="n">USE</span><span class="w"> </span><span class="n">yosan</span><span class="w"></span>
<span class="k">EXEC</span><span class="w"> </span><span class="n">sp_change_users_login</span><span class="w"> </span><span class="s1">&#39;Report&#39;</span><span class="w"></span>
<span class="k">go</span><span class="w"></span>
<span class="cm">/*</span>
<span class="cm">  ユーザーマッピングの修復方法 </span>
<span class="cm">  (EXEC sp_change_users_login &#39;Update_One&#39;, &#39;現在のDBに存在するユーザー名&#39;, &#39;SQL Serverログイン名&#39;</span>
<span class="cm">*/</span><span class="w"></span>
<span class="n">USE</span><span class="w"> </span><span class="n">yosan</span><span class="w"></span>
<span class="k">EXEC</span><span class="w"> </span><span class="n">sp_change_users_login</span><span class="w"> </span><span class="s1">&#39;Update_One&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;yosan&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;yosan&#39;</span><span class="w"></span>
<span class="k">GO</span><span class="w"></span>

<span class="n">USE</span><span class="w"> </span><span class="n">yosan_old</span><span class="w"></span>
<span class="k">EXEC</span><span class="w"> </span><span class="n">sp_change_users_login</span><span class="w"> </span><span class="s1">&#39;Update_One&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;yosan&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;yosan&#39;</span><span class="w"></span>
<span class="k">GO</span><span class="w"></span>

<span class="n">USE</span><span class="w"> </span><span class="n">yosan_test</span><span class="w"></span>
<span class="k">EXEC</span><span class="w"> </span><span class="n">sp_change_users_login</span><span class="w"> </span><span class="s1">&#39;Update_One&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;yosan&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;yosan&#39;</span><span class="w"></span>
<span class="k">GO</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h2><span class="section-number">3.1.6. </span>デバッグ権限付与<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="cm">/*Windowsアカウントにデバッグ権限を与える*/</span><span class="w"></span>
<span class="k">exec</span><span class="w"> </span><span class="n">sp_addsrvrolemember</span><span class="w"> </span><span class="s1">&#39;MSK-INC\tamagawa.kenzi&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sysadmin&#39;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h2><span class="section-number">3.1.7. </span>ストアド検索<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXEC</span><span class="w"> </span><span class="n">sp_helptext</span><span class="w"> </span><span class="ss">&quot;ストアドプロシージャ名&quot;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h2><span class="section-number">3.1.8. </span>インデックスの断片化<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- DB_IDを対象のデータベースに変更すること</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">index_id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">avg_fragmentation_in_percent</span><span class="w">  </span>
<span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">dm_db_index_physical_stats</span><span class="w"> </span><span class="p">(</span><span class="n">DB_ID</span><span class="p">(</span><span class="n">N</span><span class="s1">&#39;TPORT_DB&#39;</span><span class="p">),</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="w">  </span>
<span class="w">    </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">indexes</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b</span><span class="w"> </span>
<span class="w">      </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">object_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">index_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">index_id</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">avg_fragmentation_in_percent</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">15</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">name</span><span class="w"></span>
<span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h2><span class="section-number">3.1.9. </span>ヒット率<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="ss">&quot;[バッファキャッシュヒット率]&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">opc</span><span class="p">.</span><span class="n">cntr_value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bcr</span><span class="p">.</span><span class="n">cntr_value</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">dm_os_performance_counters</span><span class="w"> </span><span class="n">opc</span><span class="w"></span>
<span class="k">JOIN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">cntr_value</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">object_name</span><span class="w"> </span>
<span class="w">      </span><span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">dm_os_performance_counters</span><span class="w">  </span>
<span class="w">      </span><span class="k">WHERE</span><span class="w"> </span><span class="n">counter_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Buffer cache hit ratio base&#39;</span><span class="w"></span>
<span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">object_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%Buffer Manager%&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">bcr</span><span class="w"> </span>
<span class="k">ON</span><span class="w">  </span><span class="n">opc</span><span class="p">.</span><span class="n">OBJECT_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bcr</span><span class="p">.</span><span class="n">OBJECT_NAME</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">opc</span><span class="p">.</span><span class="n">counter_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Buffer cache hit ratio&#39;</span><span class="w"></span>
<span class="k">AND</span><span class="w"> </span><span class="n">opc</span><span class="p">.</span><span class="n">OBJECT_NAME</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%Buffer Manager%&#39;</span><span class="w"></span>
<span class="p">;</span><span class="w"></span>

<span class="k">SELECT</span><span class="w"> </span><span class="ss">&quot;[プランキャッシュヒット率]&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">opc</span><span class="p">.</span><span class="n">cntr_value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bcr</span><span class="p">.</span><span class="n">cntr_value</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">dm_os_performance_counters</span><span class="w"> </span><span class="n">opc</span><span class="w"></span>
<span class="k">JOIN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">counter_name</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">cntr_value</span><span class="p">,</span><span class="w"></span>
<span class="w">             </span><span class="n">object_name</span><span class="w"> </span>
<span class="w">      </span><span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">dm_os_performance_counters</span><span class="w">  </span>
<span class="w">      </span><span class="k">WHERE</span><span class="w"> </span><span class="n">counter_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Cache Hit Ratio Base&#39;</span><span class="w"></span>
<span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">object_name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%Plan Cache%&#39;</span><span class="w"> </span>
<span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">instance_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;_Total&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">bcr</span><span class="w"> </span>
<span class="k">ON</span><span class="w">  </span><span class="n">opc</span><span class="p">.</span><span class="n">OBJECT_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bcr</span><span class="p">.</span><span class="n">OBJECT_NAME</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">opc</span><span class="p">.</span><span class="n">counter_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Cache Hit Ratio&#39;</span><span class="w"></span>
<span class="k">AND</span><span class="w"> </span><span class="n">opc</span><span class="p">.</span><span class="n">OBJECT_NAME</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%Plan Cache%&#39;</span><span class="w"></span>
<span class="k">AND</span><span class="w"> </span><span class="n">opc</span><span class="p">.</span><span class="n">instance_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;_Total&#39;</span><span class="w"></span>
<span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h2><span class="section-number">3.1.10. </span>統計情報の調査<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- 一覧</span>
<span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="n">so</span><span class="p">.</span><span class="n">name</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">name</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">auto_created</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">user_created</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">no_recompute</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">STATS_DATE</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">object_id</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">stats_id</span><span class="p">)</span><span class="w"></span>
<span class="k">FROM</span><span class="w"></span>
<span class="w">    </span><span class="n">sys</span><span class="p">.</span><span class="n">objects</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">so</span><span class="w"></span>
<span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">stats</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ss</span><span class="w"></span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">so</span><span class="p">.</span><span class="n">object_id</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">so</span><span class="p">.</span><span class="n">name</span><span class="w"></span>

<span class="c1">-- サンプリング率の確認</span>
<span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="n">OBJECT_NAME</span><span class="p">(</span><span class="n">dsp</span><span class="p">.</span><span class="n">object_id</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">dsp</span><span class="p">.</span><span class="n">object_id</span><span class="w"> </span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">name</span><span class="w"> </span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">dsp</span><span class="p">.</span><span class="n">last_updated</span><span class="w"> </span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">dsp</span><span class="p">.</span><span class="k">rows</span><span class="w"> </span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">dsp</span><span class="p">.</span><span class="n">rows_sampled</span><span class="w"> </span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">dsp</span><span class="p">.</span><span class="n">steps</span><span class="w"> </span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">dsp</span><span class="p">.</span><span class="n">unfiltered_rows</span><span class="w"> </span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">dsp</span><span class="p">.</span><span class="n">modification_counter</span><span class="w"> </span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="n">dsp</span><span class="p">.</span><span class="n">rows_sampled</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">decimal</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="n">dsp</span><span class="p">.</span><span class="k">rows</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">decimal</span><span class="p">),</span><span class="s1">&#39;##0.0#&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">[</span><span class="n">SamplingRate</span><span class="p">]</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span>
<span class="w">    </span><span class="n">sys</span><span class="p">.</span><span class="n">stats</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span>
<span class="k">CROSS</span><span class="w"> </span><span class="n">APPLY</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">dm_db_stats_properties</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">object_id</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">stats_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dsp</span><span class="w"> </span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">OBJECT_SCHEMA_NAME</span><span class="p">(</span><span class="n">dsp</span><span class="p">.</span><span class="n">object_id</span><span class="p">,</span><span class="w"> </span><span class="n">DB_ID</span><span class="p">())</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s1">&#39;sys&#39;</span><span class="w"></span>
<span class="k">Order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">OBJECT_NAME</span><span class="p">(</span><span class="n">dsp</span><span class="p">.</span><span class="n">object_id</span><span class="p">)</span><span class="w"> </span><span class="p">,[</span><span class="n">SamplingRate</span><span class="p">]</span><span class="w"></span>

<span class="c1">-- 統計更新 DB単位</span>
<span class="n">USE</span><span class="w"> </span><span class="n">TPORT_DB</span><span class="w"></span>
<span class="k">GO</span><span class="w"></span>
<span class="k">exec</span><span class="w"> </span><span class="n">sp_updatestats</span><span class="w"></span>
<span class="p">;</span><span class="w"></span>

<span class="c1">-- 統計更新 テーブル単位</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="k">STATISTICS</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">M_CENTER</span><span class="w"></span>

<span class="c1">-- 統計更新 インデックス単位</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="k">STATISTICS</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">T_EMPTYCAR</span><span class="w"> </span><span class="n">I_EMPTYCAR_03</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id12">
<h2><span class="section-number">3.1.11. </span>権限の確認<a class="headerlink" href="#id12" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- 指定したユーザーの権限一覧を表示する</span>
<span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="n">USER_NAME</span><span class="p">(</span><span class="n">grantee_principal_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">user_name</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="n">OBJECT_NAME</span><span class="p">(</span><span class="n">major_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">object_name</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="n">permission_name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="ss">&quot;権限名&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="n">state_desc</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="ss">&quot;権限の状態&quot;</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">database_permissions</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">grantee_principal_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USER_ID</span><span class="p">(</span><span class="s1">&#39;lab_user&#39;</span><span class="p">)</span><span class="w"></span>
<span class="p">;</span><span class="w"></span>
<span class="c1">-- 指定したオブジェクトの権限一覧を表示する</span>
<span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="n">OBJECT_NAME</span><span class="p">(</span><span class="n">major_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">object_name</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="n">USER_NAME</span><span class="p">(</span><span class="n">grantee_principal_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">user_name</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="n">permission_name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="ss">&quot;権限名&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="n">state_desc</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="ss">&quot;権限の状態&quot;</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">database_permissions</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">major_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OBJECT_ID</span><span class="p">(</span><span class="s1">&#39;W_TDB&#39;</span><span class="p">)</span><span class="w"></span>
<span class="p">;</span><span class="w"></span>
<span class="c1">-- 全体を確認</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">user_name</span><span class="p">(</span><span class="n">grantee_principal_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">user_name</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">class_desc</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">object_class</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">object_name</span><span class="p">(</span><span class="n">major_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">object_name</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">permission_name</span><span class="w"></span>
<span class="k">FROM</span><span class="w"></span>
<span class="w">    </span><span class="n">sys</span><span class="p">.</span><span class="n">database_permissions</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"></span>
<span class="w">    </span><span class="n">grantee_principal_id</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">class</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">major_id</span><span class="w"></span>
<span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="LOG_DB.html" class="btn btn-neutral float-right" title="3.2. LOG_DB" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="index.html" class="btn btn-neutral float-left" title="3. 保守用：SQL Server" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, k_tamagawa.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>